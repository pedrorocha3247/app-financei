<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro e Sonhos</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Canvas Confetti for animations -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .btn-primary { 
            background-color: #4f46e5; 
            color: white;
            box-shadow: 0 4px 14px 0 rgb(79 70 229 / 39%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover { 
            background-color: #4338ca;
            box-shadow: 0 6px 20px 0 rgb(79 70 229 / 45%);
        }
        .btn-primary:disabled {
            background-color: #a5b4fc;
            cursor: not-allowed;
            box-shadow: none;
        }
        .tab-btn {
            padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600;
            cursor: pointer; transition: all 0.3s ease; border: 2px solid transparent;
        }
        .tab-btn.active { background-color: #4f46e5; color: white; }
        .tab-btn:not(.active) { background-color: #e0e7ff; color: #4f46e5; }
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); display: flex;
            justify-content: center; align-items: center; z-index: 50;
            transition: opacity 0.3s ease;
        }
        .dream-completed-card {
            border-left: 4px solid #22c55e;
            background-color: #f0fdf4;
        }
        .collapsible-content {
            max-height: 1000px; overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out, margin 0.5s ease-in-out;
        }
        .collapsible-content.collapsed {
            max-height: 0; padding-top: 0 !important; padding-bottom: 0 !important; margin-top: 0 !important;
        }
        .toggle-icon { transition: transform 0.3s ease; }
        .toggle-icon.collapsed { transform: rotate(-90deg); }

        /* Animações */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .animate-slide-up { animation: slideUp 0.5s ease-out forwards; }
        .content-transition { transition: opacity 0.3s ease-in-out; }

        /* Novo Controle Segmentado */
        .segmented-control {
            display: grid;
            grid-auto-flow: column;
            grid-auto-columns: 1fr;
            border-radius: 0.5rem;
            background-color: #eef2ff;
            padding: 0.25rem;
        }
        .segmented-control-option {
            text-align: center;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            color: #4338ca;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .segmented-control-option.active {
            background-color: #4f46e5;
            color: white;
            box-shadow: 0 2px 4px rgb(0 0 0 / 0.1);
        }
        /* Ajuste de padding para inputs */
        input[type="text"], input[type="number"], input[type="date"], select {
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            padding-left: 0.75rem;
            padding-right: 0.75rem;
        }
    </style>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Tela de Iniciar (Splash Screen) -->
    <div id="splash-screen" class="fixed inset-0 bg-indigo-600 flex flex-col justify-center items-center z-50 transition-opacity duration-700 ease-out">
        <i class="fas fa-wallet text-white text-6xl animate-pulse"></i>
        <h1 class="text-4xl font-bold text-white mt-4 animate-fade-in" style="animation-delay: 200ms;">Minhas Finanças</h1>
        <button id="start-app-btn" class="absolute bottom-20 bg-white text-indigo-600 font-bold py-3 px-8 rounded-full shadow-lg transform transition-all duration-500 opacity-0 scale-95 hover:bg-gray-200">
            Iniciar
        </button>
    </div>

    <!-- Conteúdo Principal do App -->
    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-7xl opacity-0 transition-opacity duration-500">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Minhas Finanças</h1>
            <p class="text-gray-600 mt-2">Organize suas finanças e realize seus sonhos.</p>
        </header>

        <!-- Navegação por Abas -->
        <nav class="flex justify-center space-x-4 mb-8">
            <button id="tab-geral" class="tab-btn active"><i class="fas fa-wallet mr-2"></i>Visão Geral</button>
            <button id="tab-sonhos" class="tab-btn"><i class="fas fa-star mr-2"></i>Meus Sonhos</button>
        </nav>

        <!-- Conteúdo da Aba: Visão Geral -->
        <div id="view-geral">
            <!-- Seletor de Mês -->
            <section class="flex justify-center items-center space-x-2 md:space-x-4 mb-8">
                <button id="prev-month-btn" class="p-2 rounded-full hover:bg-indigo-100 text-indigo-600 transition-colors"><i class="fas fa-chevron-left"></i></button>
                <div class="flex items-center space-x-2">
                    <h2 id="current-month-display" class="text-2xl font-bold text-center w-52 md:w-64"></h2>
                    <button id="today-btn" class="bg-indigo-100 text-indigo-700 text-xs font-bold px-3 py-1 rounded-full hover:bg-indigo-200 transition-colors">Hoje</button>
                </div>
                <button id="next-month-btn" class="p-2 rounded-full hover:bg-indigo-100 text-indigo-600 transition-colors"><i class="fas fa-chevron-right"></i></button>
            </section>

            <section id="summary-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 content-transition">
                <div class="card p-6 flex items-center justify-between bg-gray-50">
                    <div><h2 class="text-lg font-semibold text-gray-500">Saldo Anterior</h2><p id="saldo-anterior" class="text-3xl font-bold text-gray-700">R$ 0,00</p></div>
                    <div class="bg-gray-200 p-3 rounded-full"><i class="fas fa-history text-gray-600 fa-2x"></i></div>
                </div>
                <div class="card p-6 flex items-center justify-between">
                    <div><h2 class="text-lg font-semibold text-gray-500">Receitas do Mês</h2><p id="total-receitas" class="text-3xl font-bold text-green-600">R$ 0,00</p></div>
                    <div class="bg-green-100 p-3 rounded-full"><i class="fas fa-arrow-up text-green-600 fa-2x"></i></div>
                </div>
                <div class="card p-6 flex items-center justify-between">
                    <div><h2 class="text-lg font-semibold text-gray-500">Despesas do Mês</h2><p id="total-despesas" class="text-3xl font-bold text-red-600">R$ 0,00</p></div>
                    <div class="bg-red-100 p-3 rounded-full"><i class="fas fa-arrow-down text-red-600 fa-2x"></i></div>
                </div>
                <div class="card p-6 flex items-center justify-between">
                    <div><h2 class="text-lg font-semibold text-gray-500">Saldo Final</h2><p id="saldo-atual" class="text-3xl font-bold text-blue-600">R$ 0,00</p></div>
                     <div class="bg-blue-100 p-3 rounded-full"><i class="fas fa-wallet text-blue-600 fa-2x"></i></div>
                </div>
            </section>
            
            <section class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                <!-- Seção de Previsão de Gastos -->
                <div id="forecast-section" class="card p-6">
                    <div data-toggle="forecast-content" class="flex justify-between items-center cursor-pointer">
                        <h3 class="text-xl font-bold">Previsão de Gastos do Mês</h3>
                        <i class="fas fa-chevron-down toggle-icon collapsed"></i>
                    </div>
                    <div id="forecast-content" class="collapsible-content collapsed pt-4">
                        <div class="space-y-4">
                            <div>
                                <div class="flex items-center justify-between">
                                    <p id="fixed-expenses-label" class="text-sm text-gray-500">Despesas Fixas</p>
                                    <button id="manage-fixed-expenses-btn" class="text-xs text-indigo-600 font-semibold hover:underline">Gerenciar</button>
                                </div>
                                <p id="fixed-expenses-total" class="text-2xl font-bold text-orange-600">R$ 0,00</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Despesas Variáveis (Realizadas)</p>
                                <p id="variable-expenses-total" class="text-2xl font-bold text-yellow-600">R$ 0,00</p>
                            </div>
                        </div>
                    </div>
                </div>
                 <!-- Seção de Recebimentos Agendados -->
                <div id="scheduled-section" class="card p-6">
                    <div data-toggle="scheduled-content" class="flex justify-between items-center cursor-pointer">
                        <h3 class="text-xl font-bold">Recebimentos e Pagamentos Agendados</h3>
                        <i class="fas fa-chevron-down toggle-icon collapsed"></i>
                    </div>
                    <div id="scheduled-content" class="collapsible-content collapsed pt-4">
                        <ul id="scheduled-transactions-list" class="space-y-3"></ul>
                    </div>
                </div>
            </section>

            <main id="main-content" class="grid grid-cols-1 lg:grid-cols-2 gap-8 content-transition">
                <div class="lg:col-span-1 space-y-8">
                    <div class="card p-6">
                        <h3 class="text-xl font-bold mb-4">Adicionar Transação</h3>
                        <form id="transaction-form" class="space-y-4">
                            <div>
                                <label for="descricao" class="block text-sm font-medium text-gray-700">Descrição</label>
                                <div class="mt-1">
                                    <input type="text" id="descricao" placeholder="Ex: Salário, Aluguel" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                                </div>
                            </div>
                            <div>
                                <label for="valor" class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                                <div class="mt-1">
                                    <input type="text" id="valor" placeholder="0,00" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Tipo</label>
                                <div id="type-selector" class="segmented-control mt-1">
                                    <div class="segmented-control-option" data-value="receita"><i class="fas fa-plus-circle mr-2"></i>Receita</div>
                                    <div class="segmented-control-option" data-value="despesa"><i class="fas fa-minus-circle mr-2"></i>Despesa</div>
                                </div>
                            </div>
                            <div id="receita-details-container" class="hidden space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Tipo de Receita</label>
                                    <div id="receita-type-selector" class="segmented-control mt-1">
                                        <div class="segmented-control-option active" data-value="variavel">Variável</div>
                                        <div class="segmented-control-option" data-value="fixa">Fixa</div>
                                    </div>
                                </div>
                                <div id="receita-date-container" class="hidden">
                                    <label for="receita-dia" class="block text-sm font-medium text-gray-700">Dia do Mês</label>
                                    <input type="number" id="receita-dia" min="1" max="31" placeholder="Ex: 5" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                                </div>
                            </div>
                            <div id="expense-details-container" class="hidden space-y-4">
                                <div>
                                    <label class="block text-sm font-medium">Categoria</label>
                                    <select id="categoria" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"><option>Moradia</option><option>Alimentação</option><option>Transporte</option><option>Lazer</option><option>Saúde</option><option>Outros</option></select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Tipo de Gasto</label>
                                    <div id="gasto-type-selector" class="segmented-control mt-1">
                                        <div class="segmented-control-option active" data-value="variavel">Variável</div>
                                        <div class="segmented-control-option" data-value="fixa">Fixa</div>
                                    </div>
                                </div>
                                <div id="despesa-date-container" class="hidden">
                                    <label for="despesa-dia" class="block text-sm font-medium text-gray-700">Dia do Mês</label>
                                    <input type="number" id="despesa-dia" min="1" max="31" placeholder="Ex: 10" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                                </div>
                            </div>
                            <button type="submit" id="add-transaction-btn" class="w-full btn-primary font-bold py-2.5 px-4 rounded-md" disabled>Adicionar</button>
                        </form>
                    </div>
                    <div class="card p-6">
                        <div data-toggle="chart-content" class="flex justify-between items-center cursor-pointer">
                            <h3 class="text-xl font-bold">Despesas por Categoria</h3>
                            <i class="fas fa-chevron-down toggle-icon collapsed"></i>
                        </div>
                        <div id="chart-content" class="collapsible-content collapsed pt-4 flex flex-col md:flex-row items-center gap-4">
                            <div class="w-full md:w-1/2 h-48 relative"><canvas id="expense-chart"></canvas></div>
                            <div id="chart-legend" class="w-full md:w-1/2"></div>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-1 card p-6">
                    <div data-toggle="history-content" class="flex justify-between items-center cursor-pointer">
                        <h3 class="text-xl font-bold">Histórico de Transações do Mês</h3>
                        <i class="fas fa-chevron-down toggle-icon collapsed"></i>
                    </div>
                    <div id="history-content" class="collapsible-content collapsed pt-4">
                        <ul id="transaction-list" class="space-y-3"></ul>
                    </div>
                </div>
            </main>
        </div>

        <!-- Conteúdo da Aba: Meus Sonhos -->
        <div id="view-sonhos" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold">Seus Sonhos e Objetivos</h2>
                <button id="add-sonho-btn" class="btn-primary font-bold py-2 px-4 rounded-md flex items-center"><i class="fas fa-plus mr-2"></i>Novo Sonho</button>
            </div>
            <div id="sonhos-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Cards de sonhos em andamento -->
            </div>

            <!-- Seção Sonhos Realizados -->
            <div id="sonhos-realizados-container" class="mt-12 hidden">
                 <div data-toggle="realizados-content" class="flex justify-between items-center cursor-pointer card p-4 mb-4 bg-green-50 border-l-4 border-green-500">
                    <h3 class="text-2xl font-bold text-green-800">
                        <i class="fas fa-trophy mr-2"></i>Sonhos Realizados
                    </h3>
                    <i class="fas fa-chevron-down toggle-icon collapsed"></i>
                </div>
                <div id="realizados-content" class="collapsible-content collapsed">
                     <div id="sonhos-realizados-list" class="space-y-6 pt-4">
                        <!-- Cards de sonhos realizados -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modais -->
    <div id="fixed-transactions-modal" class="modal-backdrop hidden"><div class="card p-8 rounded-lg w-11/12 md:w-2/3 max-w-3xl"><div class="flex justify-between items-center mb-6"><h3 id="fixed-modal-title" class="text-2xl font-bold">Gerenciar Transações Fixas</h3><button id="close-fixed-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button></div><div id="fixed-transactions-list" class="space-y-4 max-h-96 overflow-y-auto"></div></div></div>
    <div id="edit-transaction-modal" class="modal-backdrop hidden"><div class="card p-8 rounded-lg w-11/12 md:w-1/3"><h3 class="text-2xl font-bold mb-6">Editar Transação</h3><form id="edit-transaction-form" class="space-y-4"><input type="hidden" id="edit-transaction-id"><div><label for="edit-descricao" class="block text-sm font-medium">Descrição</label><input type="text" id="edit-descricao" class="mt-1 block w-full border-gray-300 rounded-md" required></div><div><label for="edit-valor" class="block text-sm font-medium">Valor (R$)</label><input type="text" id="edit-valor" class="mt-1 block w-full border-gray-300 rounded-md" required></div><div><label class="block text-sm font-medium">Tipo</label><div id="edit-type-selector" class="segmented-control mt-1"><div class="segmented-control-option" data-value="receita"><i class="fas fa-plus-circle mr-2"></i>Receita</div><div class="segmented-control-option" data-value="despesa"><i class="fas fa-minus-circle mr-2"></i>Despesa</div></div></div><div id="edit-receita-details-container" class="hidden space-y-4"><div><label class="block text-sm font-medium">Tipo de Receita</label><div id="edit-receita-type-selector" class="segmented-control mt-1"><div class="segmented-control-option" data-value="variavel">Variável</div><div class="segmented-control-option" data-value="fixa">Fixa</div></div></div><div id="edit-receita-date-container" class="hidden"><label for="edit-receita-dia" class="block text-sm font-medium">Dia do Mês</label><input type="number" id="edit-receita-dia" min="1" max="31" class="mt-1 block w-full border-gray-300 rounded-md"></div></div><div id="edit-expense-details-container" class="hidden space-y-4"><div><label class="block text-sm font-medium">Categoria</label><select id="edit-categoria" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"><option>Moradia</option><option>Alimentação</option><option>Transporte</option><option>Lazer</option><option>Saúde</option><option>Outros</option></select></div><div><label class="block text-sm font-medium">Tipo de Gasto</label><div id="edit-gasto-type-selector" class="segmented-control mt-1"><div class="segmented-control-option" data-value="variavel">Variável</div><div class="segmented-control-option" data-value="fixa">Fixa</div></div></div><div id="edit-despesa-date-container" class="hidden"><label for="edit-despesa-dia" class="block text-sm font-medium">Dia do Mês</label><input type="number" id="edit-despesa-dia" min="1" max="31" class="mt-1 block w-full border-gray-300 rounded-md"></div></div><div class="mt-6 flex justify-end space-x-4"><button type="button" id="cancel-edit-btn" class="bg-gray-200 font-bold py-2 px-4 rounded-md">Cancelar</button><button type="submit" class="btn-primary font-bold py-2 px-4 rounded-md">Salvar</button></div></form></div></div>
    <div id="add-sonho-modal" class="modal-backdrop hidden"><div class="card p-8 rounded-lg w-11/12 md:w-1/3"><h3 class="text-2xl font-bold mb-6">Qual é o seu novo sonho?</h3><form id="sonho-form"><div class="space-y-4"><div><label for="sonho-nome" class="block text-sm font-medium">Nome do Sonho</label><input type="text" id="sonho-nome" placeholder="Ex: Carro Novo" class="mt-1 block w-full border-gray-300 rounded-md" required></div><div><label for="sonho-valor" class="block text-sm font-medium">Valor Total (R$)</label><input type="text" id="sonho-valor" placeholder="0,00" class="mt-1 block w-full border-gray-300 rounded-md" required></div><div><label for="sonho-data" class="block text-sm font-medium">Data Alvo</label><input type="date" id="sonho-data" class="mt-1 block w-full border-gray-300 rounded-md" required></div></div><div class="mt-6 flex justify-end space-x-4"><button type="button" id="cancel-sonho-btn" class="bg-gray-200 font-bold py-2 px-4 rounded-md">Cancelar</button><button type="submit" class="btn-primary font-bold py-2 px-4 rounded-md">Salvar</button></div></form></div></div>
    <div id="edit-sonho-modal" class="modal-backdrop hidden"><div class="card p-8 rounded-lg w-11/12 md:w-1/3"><h3 class="text-2xl font-bold mb-6">Editar Sonho</h3><form id="edit-sonho-form"><input type="hidden" id="edit-sonho-id"><div class="space-y-4"><div><label for="edit-sonho-nome" class="block text-sm font-medium">Nome do Sonho</label><input type="text" id="edit-sonho-nome" class="mt-1 block w-full border-gray-300 rounded-md" required></div><div><label for="edit-sonho-valor" class="block text-sm font-medium">Valor Total (R$)</label><input type="text" id="edit-sonho-valor" class="mt-1 block w-full border-gray-300 rounded-md" required></div><div><label for="edit-sonho-data" class="block text-sm font-medium">Data Alvo</label><input type="date" id="edit-sonho-data" class="mt-1 block w-full border-gray-300 rounded-md" required></div></div><div class="mt-6 flex justify-end space-x-4"><button type="button" id="cancel-edit-sonho-btn" class="bg-gray-200 font-bold py-2 px-4 rounded-md">Cancelar</button><button type="submit" class="btn-primary font-bold py-2 px-4 rounded-md">Salvar</button></div></form></div></div>
    <div id="add-deposito-modal" class="modal-backdrop hidden"><div class="card p-8 rounded-lg w-11/12 md:w-1/3"><h3 class="text-2xl font-bold mb-2">Adicionar Depósito</h3><p class="mb-6 text-gray-600">Para: <span id="deposito-sonho-nome" class="font-semibold"></span></p><form id="deposito-form"><input type="hidden" id="deposito-sonho-id"><div><label for="deposito-valor" class="block text-sm font-medium">Valor (R$)</label><input type="text" id="deposito-valor" placeholder="0,00" class="mt-1 block w-full border-gray-300 rounded-md" required></div><div class="mt-6 flex justify-end space-x-4"><button type="button" id="cancel-deposito-btn" class="bg-gray-200 font-bold py-2 px-4 rounded-md">Cancelar</button><button type="submit" class="btn-primary font-bold py-2 px-4 rounded-md">Adicionar</button></div></form></div></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        let transactions = JSON.parse(localStorage.getItem('finance_transactions_v16')) || [];
        let dreams = JSON.parse(localStorage.getItem('finance_dreams_v16')) || [];
        let currentDate = new Date();

        const saveTransactions = () => localStorage.setItem('finance_transactions_v16', JSON.stringify(transactions));
        const saveDreams = () => localStorage.setItem('finance_dreams_v16', JSON.stringify(dreams));
        const formatCurrency = (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const formatDate = (dateString) => new Date(dateString).toLocaleDateString('pt-BR', {timeZone: 'UTC'});
        
        const elements = {
            splashScreen: document.getElementById('splash-screen'),
            startAppBtn: document.getElementById('start-app-btn'),
            appContainer: document.getElementById('app-container'),
            viewGeral: document.getElementById('view-geral'),
            viewSonhos: document.getElementById('view-sonhos'),
            tabGeralBtn: document.getElementById('tab-geral'),
            tabSonhosBtn: document.getElementById('tab-sonhos'),
            currentMonthDisplay: document.getElementById('current-month-display'),
            prevMonthBtn: document.getElementById('prev-month-btn'),
            nextMonthBtn: document.getElementById('next-month-btn'),
            todayBtn: document.getElementById('today-btn'),
            summaryCards: document.getElementById('summary-cards'),
            mainContent: document.getElementById('main-content'),
            transactionForm: document.getElementById('transaction-form'),
            addTransactionBtn: document.getElementById('add-transaction-btn'),
            saldoAnteriorEl: document.getElementById('saldo-anterior'),
            totalReceitasEl: document.getElementById('total-receitas'),
            totalDespesasEl: document.getElementById('total-despesas'),
            saldoAtualEl: document.getElementById('saldo-atual'),
            fixedExpensesTotalEl: document.getElementById('fixed-expenses-total'),
            fixedExpensesLabel: document.getElementById('fixed-expenses-label'),
            variableExpensesTotalEl: document.getElementById('variable-expenses-total'),
            scheduledTransactionsList: document.getElementById('scheduled-transactions-list'),
            transactionListEl: document.getElementById('transaction-list'),
            receitaDetailsContainer: document.getElementById('receita-details-container'),
            expenseDetailsContainer: document.getElementById('expense-details-container'),
            typeSelector: document.getElementById('type-selector'),
            receitaTypeSelector: document.getElementById('receita-type-selector'),
            gastoTypeSelector: document.getElementById('gasto-type-selector'),
            receitaDateContainer: document.getElementById('receita-date-container'),
            receitaDiaInput: document.getElementById('receita-dia'),
            despesaDateContainer: document.getElementById('despesa-date-container'),
            despesaDiaInput: document.getElementById('despesa-dia'),
            valorInput: document.getElementById('valor'),
            descricaoInput: document.getElementById('descricao'),
            chartLegend: document.getElementById('chart-legend'),
            expenseChartCanvas: document.getElementById('expense-chart').getContext('2d'),
            // Manage Fixed Modal
            manageFixedBtn: document.getElementById('manage-fixed-expenses-btn'),
            fixedTransactionsModal: document.getElementById('fixed-transactions-modal'),
            fixedTransactionsList: document.getElementById('fixed-transactions-list'),
            closeFixedModalBtn: document.getElementById('close-fixed-modal-btn'),
            fixedModalTitle: document.getElementById('fixed-modal-title'),
            // Edit Transaction Modal
            editTransactionModal: document.getElementById('edit-transaction-modal'),
            editTransactionForm: document.getElementById('edit-transaction-form'),
            cancelEditBtn: document.getElementById('cancel-edit-btn'),
            editTransactionId: document.getElementById('edit-transaction-id'),
            editDescricaoInput: document.getElementById('edit-descricao'),
            editValorInput: document.getElementById('edit-valor'),
            editTypeSelector: document.getElementById('edit-type-selector'),
            editReceitaDetailsContainer: document.getElementById('edit-receita-details-container'),
            editReceitaTypeSelector: document.getElementById('edit-receita-type-selector'),
            editReceitaDateContainer: document.getElementById('edit-receita-date-container'),
            editReceitaDiaInput: document.getElementById('edit-receita-dia'),
            editExpenseDetailsContainer: document.getElementById('edit-expense-details-container'),
            editCategoriaSelect: document.getElementById('edit-categoria'),
            editGastoTypeSelector: document.getElementById('edit-gasto-type-selector'),
            editDespesaDateContainer: document.getElementById('edit-despesa-date-container'),
            editDespesaDiaInput: document.getElementById('edit-despesa-dia'),
            // Dream Elements
            sonosListEl: document.getElementById('sonhos-list'),
            addSonhoModal: document.getElementById('add-sonho-modal'),
            sonhoForm: document.getElementById('sonho-form'),
            editSonhoModal: document.getElementById('edit-sonho-modal'),
            editSonhoForm: document.getElementById('edit-sonho-form'),
            cancelEditSonhoBtn: document.getElementById('cancel-edit-sonho-btn'),
            addDepositoModal: document.getElementById('add-deposito-modal'),
            depositoForm: document.getElementById('deposito-form'),
            sonhosRealizadosContainer: document.getElementById('sonhos-realizados-container'),
            sonosRealizadosListEl: document.getElementById('sonhos-realizados-list'),
            addSonhoBtn: document.getElementById('add-sonho-btn'),
            cancelSonhoBtn: document.getElementById('cancel-sonho-btn'),
            cancelDepositoBtn: document.getElementById('cancel-deposito-btn'),
            sonhoValorInput: document.getElementById('sonho-valor'),
            depositoValorInput: document.getElementById('deposito-valor'),
            sonhoNomeInput: document.getElementById('sonho-nome'),
        };

        let expenseChart;

        const formatCurrencyInput = (event) => {
            let value = event.target.value.replace(/\D/g, '');
            if (value === '') { event.target.value = ''; return; }
            value = (parseInt(value, 10) / 100).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
            event.target.value = value;
        };

        const parseCurrency = (value) => {
            if (typeof value !== 'string' || value === '') return 0;
            return parseFloat(value.replace(/\./g, '').replace(',', '.'));
        };
        
        const capitalizeInput = (event) => {
            const value = event.target.value;
            if (value.length > 0) {
                event.target.value = value.charAt(0).toUpperCase() + value.slice(1);
            }
        };

        const updateUIGeral = (isMonthChange = false) => {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            const animateContent = () => {
                elements.summaryCards.style.opacity = '1';
                elements.mainContent.style.opacity = '1';
                elements.currentMonthDisplay.textContent = currentDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }).replace(/^\w/, c => c.toUpperCase());
                
                carryOverFixedTransactions(); 
                
                const monthlyTransactions = transactions.filter(t => {
                    const tDate = new Date(t.date);
                    return tDate.getFullYear() === year && tDate.getMonth() === month;
                });

                const previousBalance = calculatePreviousBalance(year, month);
                const fixedForecast = calculateFixedForecast(year, month);
                const isFirstMonthEver = transactions.filter(t => new Date(t.date) < new Date(year, month, 1)).length === 0;

                updateSummary(monthlyTransactions, previousBalance, fixedForecast, isFirstMonthEver);
                renderTransactions(monthlyTransactions);
                updateExpenseChart(monthlyTransactions);
                renderScheduledTransactions();
            };

            if (isMonthChange) {
                elements.summaryCards.style.opacity = '0';
                elements.mainContent.style.opacity = '0';
                setTimeout(animateContent, 300);
            } else {
                animateContent();
            }
        };
        
        const carryOverFixedTransactions = () => {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const today = new Date();

            const fixedTransactionsToCarry = transactions.filter(t => t.receitaTipo === 'fixa' || t.gastoTipo === 'fixa');
            const uniqueFixed = [...new Map(fixedTransactionsToCarry.map(item => [item['descricao'], item])).values()];

            uniqueFixed.forEach(t => {
                const day = new Date(t.date).getDate();
                const transactionDate = new Date(year, month, day);

                if (transactionDate <= today) {
                    const alreadyExists = transactions.some(trans => {
                        const transDate = new Date(trans.date);
                        return trans.descricao === t.descricao && transDate.getFullYear() === year && transDate.getMonth() === month;
                    });

                    if (!alreadyExists) {
                        const newTransaction = { ...t, id: Date.now() + Math.random(), date: transactionDate.toISOString() };
                        transactions.push(newTransaction);
                        saveTransactions();
                    }
                }
            });
        };
        
        const calculateFixedForecast = (year, month) => {
             const prevMonthDate = new Date(year, month, 0);
            const prevMonth = prevMonthDate.getMonth();
            const prevYear = prevMonthDate.getFullYear();

            return transactions.filter(t => {
                const tDate = new Date(t.date);
                return tDate.getFullYear() === prevYear && tDate.getMonth() === prevMonth && t.gastoTipo === 'fixa';
            }).reduce((acc, t) => acc + t.valor, 0);
        }

        const calculatePreviousBalance = (year, month) => {
            const firstDayOfCurrentMonth = new Date(year, month, 1);
            return transactions.filter(t => new Date(t.date) < firstDayOfCurrentMonth)
                               .reduce((acc, t) => acc + (t.tipo === 'receita' ? t.valor : -t.valor), 0);
        };

        const updateSummary = (monthlyTransactions, previousBalance, fixedForecast, isFirstMonthEver) => {
            const monthlyRevenue = monthlyTransactions.filter(t => t.tipo === "receita").reduce((acc, t) => acc + t.valor, 0);
            const monthlyExpense = monthlyTransactions.filter(t => t.tipo === "despesa").reduce((acc, t) => acc + t.valor, 0);
            const fixedExpenseRealized = monthlyTransactions.filter(t => t.gastoTipo === "fixa").reduce((acc, t) => acc + t.valor, 0);
            const variableExpense = monthlyTransactions.filter(t => t.gastoTipo === "variavel").reduce((acc, t) => acc + t.valor, 0);
            const finalBalance = previousBalance + monthlyRevenue - monthlyExpense;

            elements.saldoAnteriorEl.textContent = formatCurrency(previousBalance);
            elements.totalReceitasEl.textContent = formatCurrency(monthlyRevenue);
            elements.totalDespesasEl.textContent = formatCurrency(monthlyExpense);
            elements.saldoAtualEl.textContent = formatCurrency(finalBalance);
            
            if (isFirstMonthEver) {
                elements.fixedExpensesLabel.textContent = "Despesas Fixas (Realizadas)";
                elements.fixedExpensesTotalEl.textContent = formatCurrency(fixedExpenseRealized);
            } else {
                elements.fixedExpensesLabel.textContent = "Despesas Fixas (Previstas)";
                elements.fixedExpensesTotalEl.textContent = formatCurrency(fixedForecast);
            }
            
            elements.variableExpensesTotalEl.textContent = formatCurrency(variableExpense);

            elements.saldoAnteriorEl.classList.toggle("text-red-500", previousBalance < 0);
            elements.saldoAnteriorEl.classList.toggle("text-gray-700", previousBalance >= 0);
            elements.saldoAtualEl.classList.toggle("text-red-500", finalBalance < 0);
            elements.saldoAtualEl.classList.toggle("text-blue-600", finalBalance >= 0);
        };

        const renderTransactions = (monthlyTransactions) => {
            elements.transactionListEl.innerHTML = "";
            if (monthlyTransactions.length === 0) {
                elements.transactionListEl.innerHTML = '<li class="text-center text-gray-500 mt-4">Nenhuma transação neste mês.</li>';
                return;
            }
            monthlyTransactions.slice().reverse().forEach(t => {
                const isReceita = t.tipo === "receita";
                const tipoTag = isReceita 
                    ? `<span class="text-xs font-semibold ${t.receitaTipo === 'fixa' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'} px-2 py-0.5 rounded-full">${t.receitaTipo}</span>`
                    : `<span class="text-xs font-semibold ${t.gastoTipo === 'fixa' ? 'bg-orange-100 text-orange-800' : 'bg-yellow-100 text-yellow-800'} px-2 py-0.5 rounded-full">${t.gastoTipo}</span>`;
                const li = document.createElement("li");
                li.className = `p-3 rounded-md ${isReceita ? "bg-green-50" : "bg-red-50"} animate-fade-in`;
                li.innerHTML = `
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                        <div class="flex items-center flex-grow mb-2 sm:mb-0">
                            <div class="mr-3 p-2 rounded-full ${isReceita ? "bg-green-200" : "bg-red-200"}">
                                <i class="fas ${isReceita ? "fa-plus text-green-700" : "fa-minus text-red-700"}"></i>
                            </div>
                            <div class="flex-grow">
                                <span class="font-semibold">${t.descricao}</span>
                                <div class="flex items-center flex-wrap mt-1 text-sm text-gray-500">
                                    <span>${formatDate(t.date)}</span>
                                    ${!isReceita ? `<span class="mx-2 text-gray-300">&bull;</span><span>${t.categoria}</span>` : ''}
                                    <span class="ml-2">${tipoTag}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center justify-end">
                            <span class="font-bold text-lg ${isReceita ? "text-green-600" : "text-red-600"}">${formatCurrency(t.valor)}</span>
                            <div class="flex ml-4">
                                <button onclick="window.openEditModal(${t.id})" class="text-gray-400 hover:text-blue-600 transition-colors"><i class="fas fa-pen"></i></button>
                                <button onclick="window.deleteTransaction(${t.id})" class="ml-3 text-gray-400 hover:text-red-600 transition-colors">&times;</button>
                            </div>
                        </div>
                    </div>
                `;
                elements.transactionListEl.appendChild(li);
            });
        };

        const updateExpenseChart = (monthlyTransactions) => {
            const expenseData = monthlyTransactions.filter(t => t.tipo === "despesa").reduce((acc, t) => { acc[t.categoria] = (acc[t.categoria] || 0) + t.valor; return acc; }, {});
            const totalExpenses = Object.values(expenseData).reduce((sum, val) => sum + val, 0);
            const chartLabels = Object.keys(expenseData);
            const chartValues = Object.values(expenseData);
            const backgroundColors = ["#4f46e5", "#f97316", "#10b981", "#3b82f6", "#ef4444", "#8b5cf6"];
            
            if (expenseChart) expenseChart.destroy();
            
            elements.chartLegend.innerHTML = '';
            if (chartLabels.length > 0) {
                const legendList = document.createElement('ul');
                legendList.className = 'space-y-2';
                chartLabels.forEach((label, index) => {
                    const percentage = totalExpenses > 0 ? ((chartValues[index] / totalExpenses) * 100).toFixed(1) : 0;
                    const li = document.createElement('li');
                    li.className = 'flex items-center text-sm';
                    li.innerHTML = `
                        <span class="w-3 h-3 rounded-full mr-2" style="background-color: ${backgroundColors[index % backgroundColors.length]}"></span>
                        <span class="flex-grow font-medium">${label}</span>
                        <span class="font-bold">${percentage}%</span>
                    `;
                    legendList.appendChild(li);
                });
                elements.chartLegend.appendChild(legendList);
            } else {
                elements.chartLegend.innerHTML = '<p class="text-center text-gray-500">Sem dados de despesa para exibir.</p>';
            }

            expenseChart = new Chart(elements.expenseChartCanvas, { type: "doughnut", data: { labels: chartLabels, datasets: [{ data: chartValues, backgroundColor: backgroundColors, borderColor: "#ffffff", borderWidth: 4 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false } } } });
        };
        
        const renderScheduledTransactions = () => {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const today = new Date().getDate();

            const uniqueFixed = [...new Map(transactions.filter(t => t.receitaTipo === 'fixa' || t.gastoTipo === 'fixa').map(item => [item['descricao'], item])).values()];
            
            const scheduledList = uniqueFixed.filter(t => {
                const day = new Date(t.date).getDate();
                const alreadyExists = transactions.some(trans => {
                    const transDate = new Date(trans.date);
                    return trans.descricao === t.descricao && transDate.getFullYear() === year && transDate.getMonth() === month;
                });
                return !alreadyExists;
            });

            elements.scheduledTransactionsList.innerHTML = '';
            if (scheduledList.length === 0) {
                elements.scheduledTransactionsList.innerHTML = '<li class="text-center text-gray-500">Nenhum agendamento futuro para este mês.</li>';
                return;
            }

            scheduledList.forEach(t => {
                const day = new Date(t.date).getDate();
                const isReceita = t.tipo === 'receita';
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center text-sm';
                li.innerHTML = `
                    <span class="flex items-center"><i class="fas ${isReceita ? 'fa-arrow-up text-green-500' : 'fa-arrow-down text-red-500'} mr-2"></i> ${t.descricao}</span>
                    <span class="font-semibold">${formatCurrency(t.valor)} - Dia ${day}</span>
                `;
                elements.scheduledTransactionsList.appendChild(li);
            });
        };

        const handleAddTransaction = (event) => {
            event.preventDefault();
            const tipo = elements.typeSelector.querySelector('.active')?.dataset.value;
            if (!tipo) return;

            const valor = parseCurrency(elements.valorInput.value);
            const receitaTipo = tipo === 'receita' ? elements.receitaTypeSelector.querySelector('.active').dataset.value : null;
            const gastoTipo = tipo === 'despesa' ? elements.gastoTypeSelector.querySelector('.active').dataset.value : null;
            
            let day;
            if (receitaTipo === 'fixa') {
                day = parseInt(elements.receitaDiaInput.value);
            } else if (gastoTipo === 'fixa') {
                day = parseInt(elements.despesaDiaInput.value);
            } else {
                day = new Date().getDate();
            }

            const transaction = { 
                id: Date.now(), 
                date: new Date(currentDate.getFullYear(), currentDate.getMonth(), day).toISOString(),
                descricao: elements.descricaoInput.value, 
                valor: valor, 
                tipo: tipo, 
                categoria: tipo === 'despesa' ? document.getElementById("categoria").value : null,
                gastoTipo: gastoTipo,
                receitaTipo: receitaTipo
            };
            if (!transaction.descricao || isNaN(transaction.valor) || transaction.valor <= 0 || ( (receitaTipo === 'fixa' || gastoTipo === 'fixa') && (!day || day < 1 || day > 31) )) {
                alert('Por favor, preencha todos os campos corretamente.');
                return;
            }
            transactions.push(transaction);
            saveTransactions();
            updateUIGeral();
            elements.transactionForm.reset();
            elements.typeSelector.querySelectorAll('.segmented-control-option').forEach(opt => opt.classList.remove('active'));
            elements.expenseDetailsContainer.classList.add('hidden');
            elements.receitaDetailsContainer.classList.add('hidden');
            elements.addTransactionBtn.disabled = true;
        };

        window.deleteTransaction = (id) => { transactions = transactions.filter(t => t.id !== id); saveTransactions(); updateUIGeral(); };
        
        const handleTipoChange = (event) => {
            const selectedOption = event.target.closest('.segmented-control-option');
            if (!selectedOption) return;
            elements.typeSelector.querySelectorAll('.segmented-control-option').forEach(opt => opt.classList.remove('active'));
            selectedOption.classList.add('active');
            elements.addTransactionBtn.disabled = false;
            if (selectedOption.dataset.value === "despesa") {
                elements.expenseDetailsContainer.classList.remove('hidden');
                elements.receitaDetailsContainer.classList.add('hidden');
            } else {
                elements.expenseDetailsContainer.classList.add('hidden');
                elements.receitaDetailsContainer.classList.remove('hidden');
            }
        };

        const handleGastoTipoChange = (event) => {
            const selectedOption = event.target.closest('.segmented-control-option');
            if (!selectedOption) return;
            elements.gastoTypeSelector.querySelectorAll('.segmented-control-option').forEach(opt => opt.classList.remove('active'));
            selectedOption.classList.add('active');
            if (selectedOption.dataset.value === 'fixa') {
                elements.despesaDateContainer.classList.remove('hidden');
            } else {
                elements.despesaDateContainer.classList.add('hidden');
            }
        };

        const handleReceitaTipoChange = (event) => {
            const selectedOption = event.target.closest('.segmented-control-option');
            if (!selectedOption) return;
            elements.receitaTypeSelector.querySelectorAll('.segmented-control-option').forEach(opt => opt.classList.remove('active'));
            selectedOption.classList.add('active');
            if (selectedOption.dataset.value === 'fixa') {
                elements.receitaDateContainer.classList.remove('hidden');
            } else {
                elements.receitaDateContainer.classList.add('hidden');
            }
        };

        const handleToggleClick = (event) => { 
            const header = event.target.closest('[data-toggle]'); 
            if (!header) return; 
            const contentId = header.getAttribute('data-toggle'); 
            const contentElement = document.getElementById(contentId); 
            const iconElement = header.querySelector('.toggle-icon'); 
            contentElement.classList.toggle('collapsed'); 
            iconElement.classList.toggle('collapsed');
            
            if (contentId === 'chart-content' && !contentElement.classList.contains('collapsed')) {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const monthlyTransactions = transactions.filter(t => {
                    const tDate = new Date(t.date);
                    return tDate.getFullYear() === year && tDate.getMonth() === month;
                });
                updateExpenseChart(monthlyTransactions);
            }
        };
        
        window.openEditModal = (id) => {
            const transaction = transactions.find(t => t.id === id);
            if (!transaction) return;

            elements.editTransactionId.value = id;
            elements.editDescricaoInput.value = transaction.descricao;
            elements.editValorInput.value = transaction.valor.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
            
            elements.editTypeSelector.querySelectorAll('.segmented-control-option').forEach(opt => opt.classList.remove('active'));
            const typeOption = elements.editTypeSelector.querySelector(`[data-value="${transaction.tipo}"]`);
            if(typeOption) typeOption.classList.add('active');

            if (transaction.tipo === 'despesa') {
                elements.editExpenseDetailsContainer.classList.remove('hidden');
                elements.editReceitaDetailsContainer.classList.add('hidden');
                elements.editCategoriaSelect.value = transaction.categoria;
                elements.editGastoTypeSelector.querySelectorAll('.segmented-control-option').forEach(opt => opt.classList.remove('active'));
                const gastoTypeOption = elements.editGastoTypeSelector.querySelector(`[data-value="${transaction.gastoTipo}"]`);
                if(gastoTypeOption) gastoTypeOption.classList.add('active');
                if (transaction.gastoTipo === 'fixa') {
                    elements.editDespesaDateContainer.classList.remove('hidden');
                    elements.editDespesaDiaInput.value = new Date(transaction.date).getDate();
                } else {
                    elements.editDespesaDateContainer.classList.add('hidden');
                }
            } else {
                elements.editExpenseDetailsContainer.classList.add('hidden');
                elements.editReceitaDetailsContainer.classList.remove('hidden');
                elements.editReceitaTypeSelector.querySelectorAll('.segmented-control-option').forEach(opt => opt.classList.remove('active'));
                const receitaTypeOption = elements.editReceitaTypeSelector.querySelector(`[data-value="${transaction.receitaTipo}"]`);
                if(receitaTypeOption) receitaTypeOption.classList.add('active');
                 if (transaction.receitaTipo === 'fixa') {
                    elements.editReceitaDateContainer.classList.remove('hidden');
                    elements.editReceitaDiaInput.value = new Date(transaction.date).getDate();
                } else {
                    elements.editReceitaDateContainer.classList.add('hidden');
                }
            }

            elements.editTransactionModal.classList.remove('hidden');
        };

        const handleEditTransaction = (event) => {
            event.preventDefault();
            const id = parseInt(elements.editTransactionId.value);
            const transactionIndex = transactions.findIndex(t => t.id === id);
            if (transactionIndex === -1) return;

            const tipo = elements.editTypeSelector.querySelector('.active').dataset.value;
            const valor = parseCurrency(elements.editValorInput.value);
            const receitaTipo = tipo === 'receita' ? elements.editReceitaTypeSelector.querySelector('.active').dataset.value : null;
            const gastoTipo = tipo === 'despesa' ? elements.editGastoTypeSelector.querySelector('.active').dataset.value : null;
            
            let day;
            if (receitaTipo === 'fixa') {
                day = parseInt(elements.editReceitaDiaInput.value);
            } else if (gastoTipo === 'fixa') {
                day = parseInt(elements.editDespesaDiaInput.value);
            } else {
                day = new Date(transactions[transactionIndex].date).getDate();
            }
            const currentTransactionDate = new Date(transactions[transactionIndex].date);
            const date = new Date(currentTransactionDate.getFullYear(), currentTransactionDate.getMonth(), day).toISOString();

            transactions[transactionIndex] = {
                ...transactions[transactionIndex],
                descricao: elements.editDescricaoInput.value,
                valor: valor,
                date: date,
                tipo: tipo,
                categoria: tipo === 'despesa' ? elements.editCategoriaSelect.value : null,
                gastoTipo: gastoTipo,
                receitaTipo: receitaTipo
            };

            saveTransactions();
            updateUIGeral();
            elements.editTransactionModal.classList.add('hidden');
        };
        
        const openManageFixedModal = () => {
            elements.fixedTransactionsList.innerHTML = '';
            const uniqueFixed = {};
            // Pega as transações fixas de todos os tempos, dando preferência para a mais recente
            transactions.filter(t => t.receitaTipo === 'fixa' || t.gastoTipo === 'fixa').forEach(t => {
                uniqueFixed[t.descricao] = t;
            });

            const fixedList = Object.values(uniqueFixed);

            if (fixedList.length === 0) {
                elements.fixedTransactionsList.innerHTML = '<p class="text-center text-gray-500">Nenhuma transação fixa encontrada.</p>';
            } else {
                fixedList.forEach(t => {
                    const isReceita = t.tipo === 'receita';
                    const item = document.createElement('div');
                    item.className = `p-3 rounded-md flex justify-between items-center ${isReceita ? 'bg-green-50' : 'bg-red-50'}`;
                    item.innerHTML = `
                        <div class="flex-grow">
                            <p class="font-semibold">${t.descricao}</p>
                            <p class="text-sm text-gray-600">${formatCurrency(t.valor)} - Todo dia ${new Date(t.date).getDate()}</p>
                        </div>
                        <button onclick="window.openEditModal(${t.id})" class="text-gray-400 hover:text-blue-600 transition-colors"><i class="fas fa-pen"></i></button>
                    `;
                    elements.fixedTransactionsList.appendChild(item);
                });
            }
            elements.fixedTransactionsModal.classList.remove('hidden');
        };

        elements.tabGeralBtn.addEventListener('click', () => { elements.viewGeral.classList.remove('hidden'); elements.viewSonhos.classList.add('hidden'); elements.tabGeralBtn.classList.add('active'); elements.tabSonhosBtn.classList.remove('active'); });
        elements.tabSonhosBtn.addEventListener('click', () => { elements.viewGeral.classList.add('hidden'); elements.viewSonhos.classList.remove('hidden'); elements.tabGeralBtn.classList.remove('active'); elements.tabSonhosBtn.classList.add('active'); renderSonhosList(); });
        elements.transactionForm.addEventListener("submit", handleAddTransaction);
        elements.editTransactionForm.addEventListener("submit", handleEditTransaction);
        elements.typeSelector.addEventListener("click", handleTipoChange);
        elements.receitaTypeSelector.addEventListener("click", handleReceitaTipoChange);
        elements.gastoTypeSelector.addEventListener("click", handleGastoTipoChange);
        elements.editTypeSelector.addEventListener('click', (e) => {
            const selectedOption = e.target.closest('.segmented-control-option');
            if (!selectedOption) return;
            elements.editTypeSelector.querySelectorAll('.segmented-control-option').forEach(opt => opt.classList.remove('active'));
            selectedOption.classList.add('active');
            if (selectedOption.dataset.value === "despesa") {
                elements.editExpenseDetailsContainer.classList.remove('hidden');
                elements.editReceitaDetailsContainer.classList.add('hidden');
            } else {
                elements.editExpenseDetailsContainer.classList.add('hidden');
                elements.editReceitaDetailsContainer.classList.remove('hidden');
            }
        });
        elements.editGastoTypeSelector.addEventListener('click', (e) => {
            const selectedOption = e.target.closest('.segmented-control-option');
            if (!selectedOption) return;
            elements.editGastoTypeSelector.querySelectorAll('.segmented-control-option').forEach(opt => opt.classList.remove('active'));
            selectedOption.classList.add('active');
            if(selectedOption.dataset.value === 'fixa') {
                elements.editDespesaDateContainer.classList.remove('hidden');
            } else {
                elements.editDespesaDateContainer.classList.add('hidden');
            }
        });
        elements.editReceitaTypeSelector.addEventListener('click', (e) => {
            const selectedOption = e.target.closest('.segmented-control-option');
            if (!selectedOption) return;
            elements.editReceitaTypeSelector.querySelectorAll('.segmented-control-option').forEach(opt => opt.classList.remove('active'));
            selectedOption.classList.add('active');
            if(selectedOption.dataset.value === 'fixa') {
                elements.editReceitaDateContainer.classList.remove('hidden');
            } else {
                elements.editReceitaDateContainer.classList.add('hidden');
            }
        });
        document.addEventListener('click', handleToggleClick);
        elements.prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); updateUIGeral(true); });
        elements.nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); updateUIGeral(true); });
        elements.todayBtn.addEventListener('click', () => { currentDate = new Date(); updateUIGeral(true); });
        elements.cancelEditBtn.addEventListener('click', () => elements.editTransactionModal.classList.add('hidden'));
        elements.manageFixedBtn.addEventListener('click', openManageFixedModal);
        elements.closeFixedModalBtn.addEventListener('click', () => elements.fixedTransactionsModal.classList.add('hidden'));
        elements.valorInput.addEventListener('input', formatCurrencyInput);
        elements.sonhoValorInput.addEventListener('input', formatCurrencyInput);
        elements.depositoValorInput.addEventListener('input', formatCurrencyInput);
        elements.editValorInput.addEventListener('input', formatCurrencyInput);
        elements.descricaoInput.addEventListener('input', capitalizeInput);
        elements.sonhoNomeInput.addEventListener('input', capitalizeInput);
        elements.editDescricaoInput.addEventListener('input', capitalizeInput);
        
        setTimeout(() => {
            elements.startAppBtn.style.opacity = '1';
            elements.startAppBtn.style.transform = 'scale(1)';
        }, 1500);

        elements.startAppBtn.addEventListener('click', () => {
            elements.splashScreen.style.opacity = '0';
            elements.splashScreen.addEventListener('transitionend', () => { elements.splashScreen.classList.add('hidden'); });
            elements.appContainer.style.opacity = '1';
            document.querySelectorAll('#app-container .animate-slide-up').forEach((el, index) => { el.style.animation = `slideUp 0.5s ease-out ${index * 100 + 300}ms forwards`; });
            updateUIGeral();
            renderSonhosList();
            elements.tabGeralBtn.click();
        });
    });
    </script>
    
    <!-- Script para a aba de sonhos -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (window.sonhosScriptLoaded) return;
            window.sonhosScriptLoaded = true;

            let dreams = JSON.parse(localStorage.getItem('finance_dreams_v16')) || [];
            const saveDreams = () => localStorage.setItem('finance_dreams_v16', JSON.stringify(dreams));
            const formatCurrency = (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const formatDate = (dateString) => new Date(dateString).toLocaleDateString('pt-BR', { timeZone: 'UTC' });
            const parseCurrency = (value) => {
                if (typeof value !== 'string' || value === '') return 0;
                return parseFloat(value.replace(/\./g, '').replace(',', '.'));
            };
            
            const elements = {
                sonosListEl: document.getElementById('sonhos-list'),
                addSonhoModal: document.getElementById('add-sonho-modal'),
                sonhoForm: document.getElementById('sonho-form'),
                editSonhoModal: document.getElementById('edit-sonho-modal'),
                editSonhoForm: document.getElementById('edit-sonho-form'),
                cancelEditSonhoBtn: document.getElementById('cancel-edit-sonho-btn'),
                addDepositoModal: document.getElementById('add-deposito-modal'),
                depositoForm: document.getElementById('deposito-form'),
                sonhosRealizadosContainer: document.getElementById('sonhos-realizados-container'),
                sonosRealizadosListEl: document.getElementById('sonhos-realizados-list'),
                addSonhoBtn: document.getElementById('add-sonho-btn'),
                cancelSonhoBtn: document.getElementById('cancel-sonho-btn'),
                cancelDepositoBtn: document.getElementById('cancel-deposito-btn'),
            };

            const renderSonhosList = () => {
                const ongoingDreams = dreams.filter(d => !d.completed);
                const completedDreams = dreams.filter(d => d.completed);
                elements.sonosListEl.innerHTML = '';
                if (ongoingDreams.length === 0) { elements.sonosListEl.innerHTML = `<div class="col-span-full text-center text-gray-500 mt-8 animate-fade-in"><i class="fas fa-cloud-moon fa-3x mb-4"></i><p class="text-xl">Você não tem sonhos em andamento.</p><p>Clique em "Novo Sonho" para começar a planejar!</p></div>`; } else { ongoingDreams.forEach(renderOngoingDreamCard); }
                elements.sonosRealizadosListEl.innerHTML = '';
                if (completedDreams.length > 0) { elements.sonhosRealizadosContainer.classList.remove('hidden'); completedDreams.forEach(renderCompletedDreamCard); } else { elements.sonhosRealizadosContainer.classList.add('hidden'); }
            };
            const renderOngoingDreamCard = (dream) => {
                const totalDepositado = dream.deposits.reduce((acc, d) => acc + d.valor, 0);
                const progresso = dream.valor > 0 ? Math.min((totalDepositado / dream.valor) * 100, 100) : 0;
                const restante = dream.valor - totalDepositado;
                const hoje = new Date();
                const dataAlvo = new Date(dream.dataAlvo);
                const mesesRestantes = (dataAlvo.getFullYear() - hoje.getFullYear()) * 12 + (dataAlvo.getMonth() - hoje.getMonth());
                const idealPorMes = mesesRestantes > 0 ? restante / mesesRestantes : 0;
                const card = document.createElement('div');
                card.className = `card p-6 space-y-4 animate-slide-up`;
                card.innerHTML = `<div><div class="flex justify-between items-start"><h4 class="text-2xl font-bold text-gray-800">${dream.nome}</h4><div class="flex items-center"><button onclick="window.openEditSonhoModal(${dream.id})" class="text-gray-400 hover:text-blue-600 transition-colors mr-3"><i class="fas fa-pen"></i></button><button onclick="window.deleteSonho(${dream.id})" class="text-gray-400 hover:text-red-600 transition-colors">&times;</button></div></div><p class="text-gray-500">Objetivo: <span class="font-semibold">${formatCurrency(dream.valor)}</span></p></div><div><div class="flex justify-between mb-1"><span class="font-medium text-indigo-700">${formatCurrency(totalDepositado)}</span><span class="font-medium text-indigo-700">${progresso.toFixed(1)}%</span></div><div class="w-full bg-gray-200 rounded-full h-4"><div class="bg-indigo-600 h-4 rounded-full transition-all duration-500" style="width: ${progresso}%"></div></div><p class="text-sm text-right text-gray-600 mt-1">Faltam ${formatCurrency(Math.max(0, restante))}</p></div><div class="border-t pt-4 space-y-3"><div class="flex justify-between text-sm"><span class="text-gray-500">Iniciada em:</span><span class="font-semibold">${formatDate(dream.createdAt)}</span></div><div class="flex justify-between text-sm"><span class="text-gray-500">Ideal por mês:</span><span class="font-semibold">${formatCurrency(Math.max(0, idealPorMes))}</span></div></div><div class="h-24"><canvas id="chart-sonho-${dream.id}"></canvas></div><button onclick="window.openDepositoModal(${dream.id})" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center transition-colors"><i class="fas fa-plus-circle mr-2"></i>Adicionar Depósito</button>`;
                elements.sonosListEl.appendChild(card);
                if (dream.deposits.length > 0) { const chartCtx = document.getElementById(`chart-sonho-${dream.id}`).getContext('2d'); let cumulativeAmount = 0; const chartData = dream.deposits.map(d => cumulativeAmount += d.valor); const chartLabels = dream.deposits.map(d => formatDate(d.data)); new Chart(chartCtx, { type: 'line', data: { labels: chartLabels, datasets: [{ label: 'Evolução', data: chartData, backgroundColor: 'rgba(79, 70, 229, 0.1)', borderColor: '#4f46e5', borderWidth: 2, tension: 0.3, fill: true }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } } }); }
            };
            const renderCompletedDreamCard = (dream) => {
                let depositsHTML = dream.deposits.map(d => `<li class="flex justify-between text-sm"><span class="text-gray-600">${formatDate(d.data)}</span><span class="font-medium text-green-700">+ ${formatCurrency(d.valor)}</span></li>`).join('');
                const card = document.createElement('div');
                card.className = 'card dream-completed-card p-6 animate-fade-in';
                card.innerHTML = `<div class="flex justify-between items-center mb-3"><h4 class="text-2xl font-bold text-green-800">${dream.nome}</h4><span class="bg-green-100 text-green-800 text-sm font-semibold px-3 py-1 rounded-full"><i class="fas fa-check-circle mr-1"></i>Concluído!</span></div><div class="space-y-3"><div class="flex justify-between text-sm"><span class="text-gray-500">Valor Total:</span><span class="font-semibold">${formatCurrency(dream.valor)}</span></div><div class="flex justify-between text-sm"><span class="text-gray-500">Início em:</span><span class="font-semibold">${formatDate(dream.createdAt)}</span></div><div class="flex justify-between text-sm"><span class="text-gray-500">Data de Conclusão:</span><span class="font-semibold">${formatDate(dream.deposits[dream.deposits.length - 1].data)}</span></div><div class="border-t pt-3"><p class="font-semibold mb-2">Histórico de Depósitos:</p><ul class="space-y-1 max-h-32 overflow-y-auto pr-2">${depositsHTML}</ul></div></div>`;
                elements.sonosRealizadosListEl.appendChild(card);
            };
            window.openDepositoModal = (id) => { const dream = dreams.find(d => d.id === id); document.getElementById('deposito-sonho-nome').textContent = dream.nome; document.getElementById('deposito-sonho-id').value = id; elements.addDepositoModal.classList.remove('hidden'); };
            window.deleteSonho = (id) => { if (confirm('Tem certeza que deseja apagar este sonho? A ação não pode ser desfeita.')) { dreams = dreams.filter(d => d.id !== id); saveDreams(); renderSonhosList(); } };
            window.openEditSonhoModal = (id) => {
                const dream = dreams.find(d => d.id === id);
                if (!dream) return;
                document.getElementById('edit-sonho-id').value = dream.id;
                document.getElementById('edit-sonho-nome').value = dream.nome;
                document.getElementById('edit-sonho-valor').value = dream.valor.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
                document.getElementById('edit-sonho-data').value = new Date(dream.dataAlvo).toISOString().split('T')[0];
                elements.editSonhoModal.classList.remove('hidden');
            };
            const handleEditSonho = (e) => {
                e.preventDefault();
                const id = parseInt(document.getElementById('edit-sonho-id').value);
                const dreamIndex = dreams.findIndex(d => d.id === id);
                if (dreamIndex === -1) return;
                dreams[dreamIndex] = {
                    ...dreams[dreamIndex],
                    nome: document.getElementById('edit-sonho-nome').value,
                    valor: parseCurrency(document.getElementById('edit-sonho-valor').value),
                    dataAlvo: document.getElementById('edit-sonho-data').value,
                };
                saveDreams();
                renderSonhosList();
                elements.editSonhoModal.classList.add('hidden');
            };

            elements.addSonhoBtn.addEventListener('click', () => elements.addSonhoModal.classList.remove('hidden'));
            elements.cancelSonhoBtn.addEventListener('click', () => elements.addSonhoModal.classList.add('hidden'));
            elements.cancelEditSonhoBtn.addEventListener('click', () => elements.editSonhoModal.classList.add('hidden'));
            elements.cancelDepositoBtn.addEventListener('click', () => elements.addDepositoModal.classList.add('hidden'));
            elements.sonhoForm.addEventListener('submit', (e) => { e.preventDefault(); const valor = parseCurrency(document.getElementById('sonho-valor').value); dreams.push({ id: Date.now(), nome: document.getElementById('sonho-nome').value, valor: valor, dataAlvo: document.getElementById('sonho-data').value, createdAt: new Date().toISOString(), deposits: [], completed: false }); saveDreams(); renderSonhosList(); elements.sonhoForm.reset(); elements.addSonhoModal.classList.add('hidden'); });
            elements.editSonhoForm.addEventListener('submit', handleEditSonho);
            elements.depositoForm.addEventListener('submit', (e) => { e.preventDefault(); const dreamId = parseInt(document.getElementById('deposito-sonho-id').value); const valor = parseCurrency(document.getElementById('deposito-valor').value); const dream = dreams.find(d => d.id === dreamId); if (dream && valor > 0) { const totalAnterior = dream.deposits.reduce((acc, d) => acc + d.valor, 0); dream.deposits.push({ id: Date.now(), valor: valor, data: new Date().toISOString() }); const totalAtual = totalAnterior + valor; if (totalAtual >= dream.valor && !dream.completed) { dream.completed = true; confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } }); } saveDreams(); renderSonhosList(); } elements.depositoForm.reset(); elements.addDepositoModal.classList.add('hidden'); });
            
            renderSonhosList();
        });
    </script>
</body>
</html>
